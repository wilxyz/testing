<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Margie & RJ Egg Store</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>
<body>
    <!-- SIDE NAVIGATION (Same as index.html for consistency) -->
    <nav class="side-nav" id="side-nav">
        <div class="logo">
            <img src="logo.png" alt="Egg Store Logo">
            <span>Margie and Rj's</span>
        </div>
        <a href="index.html">
            <i class="ri-home-5-line"></i>
            <span>Home</span>
        </a>
        <a href="profile.html" class="active">
            <i class="ri-user-line"></i>
            <span>Profile</span>
        </a>
        <a href="#" id="logout-btn">
            <i class="ri-logout-box-line"></i>
            <span>Logout</span>
        </a>
        <div class="toggle-btn" id="toggle-btn">
            <i class="ri-menu-line"></i>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <header class="hero">
        <h1>Your Profile</h1>
        <p>View your order history and manage order statuses.</p>
    </header>

    <section class="orders" style="min-height: 400px; padding: 2rem;">
        <div id="order-history-section">
            <h2>Order History</h2>
            <div id="filter-buttons" style="margin-bottom: 15px;">
                <button class="filter-btn active" data-status="all">All Orders</button>
                <button class="filter-btn" data-status="pending">Pending</button>
                <button class="filter-btn" data-status="Shipping">Pick-Up(3 days)</button>
                <button class="filter-btn" data-status="completed">Completed</button>
            </div>
            <div id="order-list" style="border-left: 4px solid #a8703b; border-radius: 6px;"></div>
        </div>
    </section>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content order-form" style="width:600px; max-width:90vw;"> <!-- widened modal -->
        <h2>Order Details</h2>
        <div id="modal-order-id" style="font-weight:bold; margin-bottom: 12px;"></div>
        <div id="modal-cart-items" style="margin-bottom: 12px;"></div>
        <div id="modal-cart-items-prices" style="margin-bottom: 12px; font-weight: bold;"></div> <!-- New ID for prices and total -->
        
        <label>Full Name:</label>
        <input type="text" id="modal-name" disabled>

        <label>Phone Number:</label>
        <input type="tel" id="modal-phone" disabled>

        <label>Complete Address:</label>
        <textarea id="modal-address" rows="3" disabled></textarea>

        <label>Date:</label>
        <input type="date" id="modal-date" disabled>

        <label>Notes:</label>
        <textarea id="modal-notes" rows="3" disabled></textarea>

     <!-- Order Detail Modal(Buttons) -->
        <button id="pdf-receipt-btn" style="margin-top: 15px; cursor: pointer;">PDF Receipt </button>
        <button id="close-modal-btn" style="margin-top: 15px; cursor: pointer;">Close</button>

    </div>
</div>

    <!-- Logout Confirmation Modal (Same as index.html) -->
    <div class="confirm-modal-overlay" id="logout-modal" style="display:none;">
        <div class="confirm-modal-box">
            <p>Are you sure you want to logout?</p>
            <div class="confirm-modal-buttons">
                <button class="confirm-cancel-btn" id="cancel-logout">Cancel</button>
                <button class="confirm-ok-btn" id="confirm-logout">Logout</button>
            </div>
        </div>
    </div>

<script>

let orders = JSON.parse(localStorage.getItem("orders")) || [];

/* -----------------------------------------------------
   FIX 1: EXPIRATION DAYS
----------------------------------------------------- */
const expirationDays = {
    small: 14,
    medium: 14,
    large: 14,
    xl: 14,
    jumbo: 14,
    superjumbo: 14
};

/* -----------------------------------------------------
   FIX 2: AUTO-DETECT SIZE FROM ANY PRODUCT NAME
----------------------------------------------------- */
function getSizeKey(productName) {
    const n = productName.toLowerCase();

    if (n.includes("super") && n.includes("jumbo")) return "superjumbo";
    if (n.includes("superjumbo")) return "superjumbo";

    if (n.includes("jumbo")) return "jumbo";
    if (n.includes("extra large") || n.includes("x-large") || n.includes("xl")) return "xl";
    if (n.includes("large")) return "large";
    if (n.includes("medium")) return "medium";
    if (n.includes("small")) return "small";

    return null; // unknown
}

/* -----------------------------------------------------
   FIX 3: EXPIRATION CALCULATION
----------------------------------------------------- */
function calculateOrderExpiry(order) {
    let longestDays = 0;

    order.cart.forEach(item => {
        const sizeKey = getSizeKey(item.name);
        if (sizeKey && expirationDays[sizeKey]) {
            longestDays = Math.max(longestDays, expirationDays[sizeKey]);
        }
    });

    // If order is pending, show full shelf life without decreasing
    if ((order.status || "").toLowerCase() === "pending") {
        return { statusText: `${longestDays} day(s) left (pending delivery)` };
    }

    // Use order date if exists, otherwise fallback to order ID
    let purchaseDate = order.date ? new Date(order.date) : new Date(Number(order.id));
    if (isNaN(purchaseDate)) purchaseDate = new Date();

    const expiresOn = new Date(purchaseDate);
    expiresOn.setDate(expiresOn.getDate() + longestDays);

    const now = new Date();
    const msLeft = expiresOn - now;
    const daysLeft = Math.ceil(msLeft / 86400000);

    if (longestDays === 0) return { statusText: "No expiration info available" };
    if (daysLeft < 0) return { statusText: `Expired (${expiresOn.toLocaleDateString()})` };
    if (daysLeft === 0) return { statusText: `Expires today (${expiresOn.toLocaleDateString()})` };

    return {
        statusText: `${daysLeft} day(s) left (expires on ${expiresOn.toLocaleDateString()})`
    };
}


/* -----------------------------------------------------
   FIX 4: ALWAYS SHOW USERNAME IF ORDER.NAME EXISTS
----------------------------------------------------- */
(function renderProfileUsername() {
    const profileHeader = document.querySelector(".hero");

    let username =
        localStorage.getItem("currentUser") ||
        (orders.length ? orders[orders.length - 1].name : "") ||
        "";

    if (!username) username = "Guest";

    let el = document.getElementById("profile-username");
    if (!el) {
        el = document.createElement("div");
        el.id = "profile-username";
        el.style.marginTop = "8px";
        el.style.fontWeight = "600";
        el.style.color = "#fff";
        profileHeader.appendChild(el);
    }

    el.textContent = "User: " + username;
})();

/* -----------------------------------------------------
   MODAL + ORDER RENDER
----------------------------------------------------- */
function openOrderModal(order) {
    document.getElementById("modal-order-id").textContent = "Order ID: " + order.id;

    let itemsHtml = "<strong>Items:</strong><ul>";
    let total = 0;
    order.cart.forEach(i => {
        const trayTypeDisplay = i.trayType === 'half' ? 'Half Tray' : 'Whole Tray';
        const itemPrice = i.price || 0;
        const itemTotal = i.qty * itemPrice;
        total += itemTotal;
        itemsHtml += `<li>${i.name} (${trayTypeDisplay}) x${i.qty} - ₱${itemTotal.toFixed(2)}</li>`;
    });
    itemsHtml += "</ul>";
    document.getElementById("modal-cart-items").innerHTML = itemsHtml;

    // New: Prices and total with ID
    document.getElementById("modal-cart-items-prices").innerHTML = `<strong>Total Price: ₱${total.toFixed(2)}</strong>`;

    document.getElementById("modal-name").value = order.name || "";
    document.getElementById("modal-phone").value = order.phone || "";
    document.getElementById("modal-address").value = order.address || "";
    document.getElementById("modal-date").value = order.date || "";
    document.getElementById("modal-notes").value = order.notes || "";

    const expiry = calculateOrderExpiry(order);

    let exp = document.getElementById("modal-expiry");
    if (!exp) {
        exp = document.createElement("p");
        exp.id = "modal-expiry";
        exp.style.fontWeight = "700";
        exp.style.marginTop = "10px";
        document.querySelector(".modal-content.order-form").appendChild(exp);
    }
    exp.textContent = "Expiration: " + expiry.statusText;

    document.getElementById("order-modal").style.display = "flex";
}

function renderOrders(filter) {
    const orderList = document.getElementById("order-list");
    orderList.innerHTML = "";

    const filterList = filter === "all"
        ? orders
        : orders.filter(o => (o.status || "").toLowerCase() === filter);

    if (!filterList.length) {
        orderList.innerHTML = `<p style="color:#6b7280;">No orders found.</p>`;
        return;
    }

    // NEW: Reverse the list so latest order is on top
    filterList.reverse();

    filterList.forEach(order => {
        const card = document.createElement("div");
        card.className = "order-card clickable";

        const expiry = calculateOrderExpiry(order);

        // Updated: Include prices and total in items display
        let items = "<strong>Items:</strong><br>";
        let total = 0;
        order.cart.forEach(i => {
            const trayTypeDisplay = i.trayType === 'half' ? 'Half Tray' : 'Whole Tray';
            const itemPrice = i.price || 0;
            const itemTotal = i.qty * itemPrice;
            total += itemTotal;
            items += `${i.name} (${trayTypeDisplay}) x${i.qty} = ₱${itemTotal.toFixed(2)}<br>`;
        });

        card.innerHTML = `
            <p><strong>Order ID:</strong> ${order.id} - ${order.name || "N/A"}</p>
            <p>${items}</p>
            <p><strong>Total Price:</strong> ₱${total.toFixed(2)}</p>
            <p><strong>Date:</strong> ${order.date || "N/A"}</p>
            <p><strong>Status:</strong> ${(order.status || "").toUpperCase()}</p>
            <p style="color:#8a6b3f; font-weight:600;"><strong>Expiration:</strong> ${expiry.statusText}</p>
        `;

        card.addEventListener("click", () => openOrderModal(order));
        orderList.appendChild(card);
    });
}


/* -----------------------------------------------------
   INIT
----------------------------------------------------- */
renderOrders("all");

document.querySelectorAll("#filter-buttons .filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        renderOrders(btn.dataset.status);
    });
});

/* -----------------------------------------------------
   Logout + Sidenav
----------------------------------------------------- */
document.getElementById("close-modal-btn").onclick = () =>
    document.getElementById("order-modal").style.display = "none";

document.getElementById("toggle-btn").onclick = () =>
    document.getElementById("side-nav").classList.toggle("expanded");

document.getElementById("logout-btn").onclick = (e) => {
    e.preventDefault();
    document.getElementById("logout-modal").style.display = "flex";
};

document.getElementById("cancel-logout").onclick = () =>
    document.getElementById("logout-modal").style.display = "none";

document.getElementById("confirm-logout").onclick = () => {
    document.getElementById("logout-modal").style.display = "none";
    alert("Logged out!");
};

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.getElementById("pdf-receipt-btn").addEventListener("click", function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Get modal info
    const orderId = document.getElementById("modal-order-id").textContent;
    const items = document.getElementById("modal-cart-items").innerText;
    const name = document.getElementById("modal-name").value;
    const phone = document.getElementById("modal-phone").value;
    const address = document.getElementById("modal-address").value;
    const date = document.getElementById("modal-date").value;
    const notes = document.getElementById("modal-notes").value;
    const expiry = document.getElementById("modal-expiry").textContent;

    // PDF content
    let y = 10;
    doc.setFontSize(16);
    doc.text("Margie & RJ Egg Store", 105, y, { align: "center" });
    y += 10;

    doc.setFontSize(14);
    doc.text("Order Receipt", 105, y, { align: "center" });
    y += 10;

    doc.setFontSize(12);
    const lineSpacing = 7;
    doc.text(orderId, 10, y); y += lineSpacing;
    doc.text("Name: " + name, 10, y); y += lineSpacing;
    doc.text("Phone: " + phone, 10, y); y += lineSpacing;
    doc.text("Address: " + address, 10, y); y += lineSpacing;
    doc.text("Date: " + date, 10, y); y += lineSpacing;
    doc.text("Notes: " + notes, 10, y); y += lineSpacing;
    doc.text("Items:", 10, y); y += lineSpacing;

    items.split("\n").forEach(item => {
        doc.text(" - " + item, 15, y);
        y += lineSpacing;
    });

    doc.text(expiry, 10, y); y += lineSpacing;

    // Download PDF with fixed name
    doc.save("receipt.pdf");
});
</script>
</body>
</html>